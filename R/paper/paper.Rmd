---
title: "Paper"
author: "Gurudev Ilangovan"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document: 
    df_print: tibble
    highlight: monochrome
    theme: flatly
    toc: yes
    toc_depth: 5
---

```{r setup, results="hide"}
knitr::opts_chunk$set(cache = T, message = FALSE)
source("R/utils.R")
```


# Data Generation

## Preprocessing

1. Read April 2013 data and March 17 data. 
2. Do some basic preprocessing
  - Assign ids
  - Calculate age from birth year
  - Add scaled frequencies
```{r preprocess}
(df_a <- 
    read_delim("data/apr13.txt", delim = "\t") %>% 
    rename(name_suffix = name_sufx_cd) %>% 
    mutate_if(is.character, str_squish) %>% 
    mutate(id_a = row_number()))
  
(df_b <- 
    read_delim("data/mar17.txt", delim = "\t") %>% 
    rename(name_suffix = name_suffix_lbl) %>% 
    mutate_if(is.character, str_squish) %>% 
    mutate(id_b = row_number()))
  
(df_a_mod <- 
  df_a %>% 
  preprocess_data())

(df_b_mod <- 
    df_b %>% 
    preprocess_data(year_a = F))

```


## Match generation

1. Extract exact matches
2. Extract voter id matches
3. Filter out exact matches from voter id matches -> matches

```{r matches}
(df_exact_matches <- 
    df_a_mod %>% 
    select(id_a, fname, lname, birth_year, gender_code, race_code) %>% 
    inner_join(df_b_mod %>% 
                 select(id_b, fname, lname, birth_year, gender_code, race_code)) %>% 
    select(starts_with("id")))

(df_vrn_matches <- 
  df_a_mod %>% 
  select(id_a, voter_reg_num) %>% 
  inner_join(df_b_mod %>% 
               select(id_b, voter_reg_num), 
             by = "voter_reg_num") %>% 
  select(starts_with("id")) %>% 
  mutate(match = "match") %>% 
  distinct())

  
df_matches_unexact <- 
  df_vrn_matches  %>% 
  anti_join(df_exact_matches) %>% 
  left_join(df_a_mod, by = "id_a") %>% 
  left_join(df_b_mod, by = "id_b", suffix = c("_a", "_b")) %>% 
  mutate(pair_id = row_number())

data_path <- "data/paper/"
data_path_file <- function(file_name) glue("{data_path}{file_name}")

if(dir_exists(data_path)){
  dir_create(data_path)
}

(df_matches_unexact %>% 
  write_rds(data_path_file("df_matches_unexact.rds")))
```

## Unmatch generation

```{r unmatches, eval=FALSE}
df_match_block <- 
  df_matches_unexact %>% 
  select(matches(or("id", "fname", "lname"))) %>% 
  mutate(fname_soundex_a = soundex(fname_a),
         fname_soundex_b = soundex(fname_b),
         fname_dm_a = map(fname_a, DoubleMetaphone),
         fname_dm1_a = map_chr(fname_dm_a, 1),
         fname_dm2_a = map_chr(fname_dm_a, 2),
         fname_dm_b = map(fname_b, DoubleMetaphone),
         fname_dm1_b = map_chr(fname_dm_b, 1),
         fname_dm2_b = map_chr(fname_dm_b, 2),
         lname_soundex_a = soundex(lname_a),
         lname_soundex_b = soundex(lname_b),
         lname_dm_a = map(lname_a, DoubleMetaphone),
         lname_dm1_a = map_chr(lname_dm_a, 1),
         lname_dm2_a = map_chr(lname_dm_a, 2),
         lname_dm_b = map(lname_b, DoubleMetaphone),
         lname_dm1_b = map_chr(lname_dm_b, 1),
         lname_dm2_b = map_chr(lname_dm_b, 2)) %>% 
  select(-fname_dm_a, -fname_dm_b, -lname_dm_a, -lname_dm_b)

df_a_block <- 
  df_a_mod %>% 
  select(id_a, fname, lname) %>% 
  rename(fname_a = fname,
         lname_a = lname) %>% 
  mutate(fname_soundex_a = soundex(fname_a),
         fname_dm_a = map(fname_a, DoubleMetaphone),
         fname_dm1_a = map_chr(fname_dm_a, 1),
         fname_dm2_a = map_chr(fname_dm_a, 2),
         lname_soundex_a = soundex(lname_a),
         lname_dm_a = map(lname_a, DoubleMetaphone),
         lname_dm1_a = map_chr(lname_dm_a, 1),
         lname_dm2_a = map_chr(lname_dm_a, 2)) %>% 
  select(-fname_dm_a, -lname_dm_a)
  

df_b_block <- 
  df_b_mod %>% 
  select(id_b, fname, lname) %>% 
  rename(fname_b = fname,
         lname_b = lname) %>% 
  mutate(fname_soundex_b = soundex(fname_b),
         fname_dm_b = map(fname_b, DoubleMetaphone),
         fname_dm1_b = map_chr(fname_dm_b, 1),
         fname_dm2_b = map_chr(fname_dm_b, 2),
         lname_soundex_b = soundex(lname_b),
         lname_dm_b = map(lname_b, DoubleMetaphone),
         lname_dm1_b = map_chr(lname_dm_b, 1),
         lname_dm2_b = map_chr(lname_dm_b, 2)) %>% 
  select(-fname_dm_b, -lname_dm_b)

df_match_block_a <- 
  df_match_block %>% 
  select(contains("_a")) 

df_match_block_b <- 
  df_match_block %>% 
  select(contains("_b")) 

df_all_combos <- 
  bind_rows(
      df_match_block_a %>% 
      inner_join(df_b_block, by = c("fname_soundex_a" = "fname_soundex_b")) %>% 
      select(id_a, id_b),
      
    df_match_block_a %>% 
      inner_join(df_b_block, by = c("fname_dm1_a" = "fname_dm1_b")) %>% 
      select(id_a, id_b),
    
    df_match_block_a %>% 
      inner_join(df_b_block, by = c("fname_dm2_a" = "fname_dm2_b")) %>% 
      select(id_a, id_b),
    
    df_match_block_a %>% 
      inner_join(df_b_block, by = c("lname_soundex_a" = "lname_soundex_b")) %>% 
      select(id_a, id_b),
    
    df_match_block_a %>% 
      inner_join(df_b_block, by = c("lname_dm1_a" = "lname_dm1_b")) %>% 
      select(id_a, id_b),
    
    df_match_block_a %>% 
      inner_join(df_b_block, by = c("lname_dm2_a" = "lname_dm2_b")) %>% 
      select(id_a, id_b),
    
    df_match_block_b %>% 
      inner_join(df_a_block, by = c("fname_soundex_b" = "fname_soundex_a")) %>% 
      select(id_a, id_b),
    
    df_match_block_b %>% 
      inner_join(df_a_block, by = c("fname_dm1_b" = "fname_dm1_a")) %>% 
      select(id_a, id_b),
    
    df_match_block_b %>% 
      inner_join(df_a_block, by = c("fname_dm2_b" = "fname_dm2_a")) %>% 
      select(id_a, id_b),
    
    df_match_block_b %>% 
      inner_join(df_a_block, by = c("lname_soundex_b" = "lname_soundex_a")) %>% 
      select(id_a, id_b),
    
    df_match_block_b %>% 
      inner_join(df_a_block, by = c("lname_dm1_b" = "lname_dm1_a")) %>% 
      select(id_a, id_b),
    
    df_match_block_b %>% 
      inner_join(df_a_block, by = c("lname_dm2_b" = "lname_dm2_a")) %>% 
      select(id_a, id_b)
  ) %>% 
  distinct()


df_all_combos_nested <- 
  df_all_combos %>% 
  left_join(df_a_mod, by = "id_a") %>% 
  left_join(df_b_mod, by = "id_b", suffix = c("_a", "_b")) %>% 
  group_by(id_a, id_b) %>% 
  nest()

n_unique <- function(x) x %>% unique() %>% length()
rename_weight <- function(x) str_c(x, "_weight")
df_to_vector <- function(df) df %>% .[1, ] %>% unclass() %>% as.double()

weight_vector <- 
  df_a_mod %>% 
  bind_rows(df_b_mod) %>% 
  select(fname, gender_code, race_code, birth_year) %>% 
  summarise_all(n_unique) %>% 
  rename_all(rename_weight) %>% 
  mutate(sum = 
           fname_weight + 
           # lname_weight + 
           gender_code_weight +
           race_code_weight +
           birth_year_weight) %>% 
  mutate_all(function(x, all) x/all, all = .$sum) %>% 
  select(-sum) %>% 
  df_to_vector()


df_all_combos_nested_sim <- 
  df_all_combos_nested %>% 
  mutate(x = map_dbl(data, calculate_hamming_fields))

df_unmatches_unexact <- 
  df_all_combos_nested_sim %>% 
  semi_join(df_matches_unexact, by = "id_a") %>% 
  group_by(id_a) %>% 
  arrange(desc(x), .by_group = T) %>% 
  slice(1:5) %>% 
  ungroup() %>% 
  select(starts_with("id")) %>% 
  left_join(df_a_mod, by = "id_a") %>%
  left_join(df_b_mod, by = "id_b", suffix = c("_a", "_b")) %>%
  mutate(pair_id = 986398  + row_number()) %>%  
  mutate(match = "unmatch")

(df_unmatches_unexact %>% 
  write_rds(data_path_file("df_unmatches_unexact.rds")))
```

```{r read_executed_unmatch, echo=FALSE}
read_data("data/paper/df_unmatches_unexact.rds")
df_unmatches_unexact
```


## Pair Generation

```{r pairs}
set.seed(1)
df_pairs <- 
  df_unmatches_unexact %>%
  bind_rows(df_matches_unexact) %>% 
  sample_n((nrow(.)))

(df_pairs %>% 
  write_rds(data_path_file("df_pairs.rds")))

(df_pairs %>% 
  vectors_to_pairs())
```


# Disturbing data

```{r add_errors}
df_pairs_a <- 
  df_pairs %>% 
  select(id_a) %>% 
  distinct() %>% 
  left_join(df_a_mod)

df_pairs_b <- 
  df_pairs %>% 
  select(id_b) %>% 
  distinct() %>% 
  left_join(df_b_mod)

df_error_table <- 
  read_csv("R/paper/error_table.csv")

set.seed(13)
df_messed_collection <- 
  tibble(error_rate = seq(0,4,1)) %>% 
    mutate(messed_data = map(error_rate, function(e){
      # browser()
      df_pairs_a %>%
        prep_data() %>%
        mess_data(df_error_table %>% 
                    mutate(amount = amount*e)) %>% 
        pluck("df_secondary") %>% 
        select(-file, -id) %>% 
        mutate_if(is.character, str_to_upper) %>% 
        mutate(birth_year = as.integer(birth_year))
    }))

df_messed_collection <- 
  df_messed_collection %>% 
  mutate(df_pairs = map(messed_data, function(df_a_messed){
    # browser()
    df_pairs %>% 
      select(id_a, id_b, match) %>% 
      left_join(df_a_messed, by = "id_a") %>% 
      left_join(df_pairs_b, by = "id_b", suffix = c("_a", "_b"))
  }))

```



# Feature Engineering

Using a function called add_feature_vector to generate features. 

```{r feature_generation}
df_messed_collection <-
  df_messed_collection %>% 
  mutate(df_feature = map(df_pairs, function(df_pair){
    df_pair %>%
      add_feature_vector() %>%
      select(starts_with("metric"), match) %>%
      mutate(match = match %>% factor(levels = c("unmatch", "match"))) %>%
      as.data.frame()
  }))
  

df_messed_collection %>%
  write_rds("data/paper/df_messed_collection.rds")
```

# Modeling

## Modeling setup

Basic modeling setup with 

- train, test split
- selecting a set of indices for cross validation of different models
- selecting a few columns out of all to measure
- other modeling choices like verbose training
```{r training_setup}
# registerDoParallel(cl)

set.seed(1)
train_indices <- 
  sample(1:nrow(df_pairs), size = floor(nrow(df_pairs)*0.85))

df_messed_collection <- 
  df_messed_collection %>% 
    mutate(
      df_train = map(df_feature, function(df_pairs_feature){
        df_pairs_feature[train_indices, ]
      }),
      df_test = map2(df_feature, df_pairs, function(df_pairs_feature, df_pair){
        # browser()
        df_pairs_feature %>% 
          bind_cols(df_pair %>% select(-contains("freq"))) %>% 
          .[-train_indices,]
      })
    )

# df_train <- 
#   df_pairs_feature[train_indices,]
# 
# df_test <- 
#   df_pairs_feature %>% 
#   bind_cols(df_pairs) %>% 
#   .[-train_indices,]

set.seed(2)
fold_indices <- createFolds(df_pairs[train_indices, ] %>% pull(match))

train_control <- 
  trainControl(index = fold_indices,
               method = "cv", 
               number = 10,
               verboseIter = FALSE,
               savePredictions = TRUE,
               classProbs = TRUE)
```


```{r model_training}
df_messed_collection <- 
  df_messed_collection %>% 
  mutate(model_rf = map(df_train, function(df_tr){
    # browser()
    set.seed(3)
    (model_rf.grid_yancey.train_features.all <-
        train(match ~ .,
              df_tr,
              # trControl = trainControl(method = "cv", number = 10),
              trControl = train_control,
              tuneGrid = expand.grid(.mtry = seq(3, 30, 3)),
              importance = TRUE,
              keep.forest= TRUE,
              ntree = 350,
              method = "rf"))
    
    model_rf.grid_yancey.train_features.all
  }))


df_messed_collection %>% 
  write_rds("data/paper/df_messed_collection_models.rds")
```

```{r test_set_evaluation}
df_messed_collection <- 
  df_messed_collection %>% 
  mutate(
    results = map2(model_rf, df_test, function(model, df){
      # print("hey")
      df %>% 
      mutate(pair_id = 1:nrow(.)) %>% 
      evaluate_model(model, df_test = .)
    }),
    metrics = map(results, ~.x$metrics$df_metric_table),
    confusion_matrix = map(results, ~.x$metrics$confusion_matrix),
    roc_curve = map(results, ~.x$metrics$roc_curve),
    pred_confidence = map(results, ~.x$confidence)
  )
```

```{r metric_review}
df_model_metrics <- 
  df_messed_collection %>% 
  select(error_rate, metrics) %>% 
  unnest(metrics) 



df_model_metrics %>% 
  filter(metric %in% c("accuracy", "precision", "recall", 
                       "f1", "precision_k", "recall_k")) %>% 
  arrange(metric, desc(value)) %>% 
  print(n = Inf)

```



